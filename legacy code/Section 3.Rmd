---
title: "Section 3 - covariates"
author: "Colin Linke"
date: "2024-06-11"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r, echo = FALSE, include = FALSE}
source("Code Transformations.R")
```

Does including Substance usage as additional Covariates show a similar story? is there a significant difference 

There is the option of using standardized transformed and / or logarithmic transformed for the variables. In the following I opted for using the standardized Data, but avoiding an additional logarithmic transformation of the substance use data due to the fact that all models performed almost identically, though with a logarithmic transformation slightly better, but this would lead to a less intuitive interpretation. Furthermore, due to a flat optimization plane and different scales the two substance usage variables lie on, the standadisation of these variables alleviates these problems somewhat.

```{r "SM"}

sm.nlme.robust2.1 <- lme(GPA ~ Avg_Drinks_current * Semester + Avg_Drinks_current * Avg_MJ_current + Avg_MJ_current * Semester, random = ~ 1| BARCS_ID, data = data.file.long, na.action = na.exclude, method = "ML")

sm.nlme.robust2.2 <- lme(GPA ~ Avg_Drinks_current * Semester + Avg_Drinks_current * Avg_MJ_current + Avg_MJ_current * Semester, random = ~ 1| BARCS_ID, data = data.file.long, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "ML")

sm.nlme.ARMA11 <- lme(GPA ~ Cluster_current * Semester, random = ~ 1| BARCS_ID, data = data.file.long, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "ML")

sm.nlme.noSemester <- lme(GPA ~ Avg_Drinks_current * Avg_MJ_current, random = ~ 1| BARCS_ID, data = data.file.long, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "ML")

sm.nlme.noSemester.time <- lme(GPA ~ Avg_Drinks_current * Avg_MJ_current + Avg_Drinks_current*Time + Avg_MJ_current*Time, random = ~ 1| BARCS_ID, data = data.file.long, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "ML")

sm.nlme.noSemester.timeRE <- lme(GPA ~ Avg_Drinks_current * Avg_MJ_current + Avg_Drinks_current*Time + Avg_MJ_current*Time, random = ~ 1 + Time| BARCS_ID, data = data.file.long, na.action = na.exclude, method = "ML")


sm.nlme.ni <- lme(GPA ~ Avg_Drinks_current + Avg_MJ_current, random = ~ 1| BARCS_ID, data = data.file.long, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "ML")

anova(sm.nlme.noSemester, sm.nlme.ni)

cowplot::plot_grid(plot(sm.nlme.robust2.1), plot(sm.nlme.robust2.2), plot(sm.nlme.ARMA11), plot(sm.nlme.noSemester), plot(sm.nlme.noSemester.time), plot(sm.nlme.noSemester.timeRE))
```
```{r, echo =FALSE, include=FALSE}
summary(sm.nlme.robust2.1)
summary(sm.nlme.robust2.2)
summary(sm.nlme.ARMA11)
summary(sm.nlme.noSemester) 
summary(sm.nlme.noSemester.time) 
summary(sm.nlme.noSemester.timeRE)
```

```{r}
AIC_values.sm.r2 <- AIC(sm.nlme.robust2.1, sm.nlme.robust2.2, sm.nlme.ARMA11, sm.nlme.noSemester, sm.nlme.noSemester.time, sm.nlme.noSemester.timeRE)
BIC_values.sm.r2 <- BIC(sm.nlme.robust2.1, sm.nlme.robust2.2, sm.nlme.ARMA11, sm.nlme.noSemester, sm.nlme.noSemester.time, sm.nlme.noSemester.timeRE)
df_scores_sm.r2 <- data.frame(AIC_values.sm.r2, BIC_values.sm.r2)
df_scores_sm.r2 ####all models have exactly 3802 observation and 1140 groups (# of students)
```
no time / Semester > Time > Semester. Semester Pretty bad. The same holds for the full model.


```{r echo=FALSE, include = FALSE}
fmri.nlme.robust2.1 <- lme(GPA ~ 1 + Avg_Drinks_current*Avg_MJ_current + Avg_Drinks_current*Semester + Avg_MJ_current*Semester  + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES, method = "ML",
                       random = ~ 1 | BARCS_ID, 
                     data = data.file.long, na.action = na.exclude)

fmri.nlme.robust2.2 <- lme(GPA ~ 1 + Avg_Drinks_current*Avg_MJ_current + Avg_Drinks_current*Semester + Avg_MJ_current*Semester  + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES, method = "ML",
                       random = ~ 1 | BARCS_ID, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), 
                     data = data.file.long, na.action = na.exclude)


fmri.nlme.ARMA11 <- lme(GPA ~ Cluster_current * Semester  + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES, method = "ML",
                         random = ~ 1| BARCS_ID, data = data.file.long, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID))

fmri.nlme.noSemester <- lme(GPA ~ Avg_Drinks_current * Avg_MJ_current + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES, method = "ML",
                         random = ~ 1| BARCS_ID, data = data.file.long, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID))

fmri.nlme.noSemester.time <- lme(GPA ~ Avg_Drinks_current * Avg_MJ_current + Avg_Drinks_current*Time + Avg_MJ_current*Time + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES, method = "ML",
                         random = ~ 1| BARCS_ID, data = data.file.long, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID))

fmri.nlme.noSemester.timeRE <- lme(GPA ~ Avg_Drinks_current * Avg_MJ_current + Avg_Drinks_current*Time + Avg_MJ_current*Time + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES, method = "ML",
                         random = ~ 1 + Time| BARCS_ID, data = data.file.long, na.action = na.exclude)



cowplot::plot_grid(plot(fmri.nlme.robust2.1), plot(fmri.nlme.robust2.2), plot(fmri.nlme.ARMA11), plot(fmri.nlme.noSemester), plot(fmri.nlme.noSemester.time), plot(fmri.nlme.noSemester.timeRE))


AIC_values.fmri.r2 <- AIC(fmri.nlme.robust2.1, fmri.nlme.robust2.2, fmri.nlme.ARMA11, fmri.nlme.noSemester, fmri.nlme.noSemester.time, fmri.nlme.noSemester.timeRE)
BIC_values.fmri.r2  <- BIC(fmri.nlme.robust2.1, fmri.nlme.robust2.2, fmri.nlme.ARMA11, fmri.nlme.noSemester, fmri.nlme.noSemester.time, fmri.nlme.noSemester.timeRE)
df_scores_fmri.r2 <- data.frame(AIC_values.fmri.r2, BIC_values.fmri.r2)
df_scores_fmri.r2
```

```{r}
fmri.nlme.simple <- lme(GPA ~ Avg_Drinks_current + Avg_MJ_current + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES, method = "ML",
                         random = ~ 1| BARCS_ID, data = data.file.long, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID))

anova(fmri.nlme.noSemester, fmri.nlme.simple)
anova(sm.nlme.noSemester, sm.nlme.ni)
AIC_interaction <- AIC(sm.nlme.noSemester, sm.nlme.ni, fmri.nlme.noSemester,fmri.nlme.simple)
BIC_interaction <- BIC(sm.nlme.noSemester, sm.nlme.ni, fmri.nlme.noSemester,fmri.nlme.simple)
df_interaction <- data.frame(AIC_interaction, BIC_interaction)
plot(fmri.nlme.simple)
plot(sm.nlme.ni)
```


```{r}
sm.outlier.barebones <- lme(GPA ~ Avg_Drinks_current + Avg_MJ_current, random = ~ 1| BARCS_ID, data = outlier.removed, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "REML")

sm.outlier.barebones.2 <- lme(GPA ~ Avg_Drinks_current + Avg_MJ_current, random = ~ 1 + Avg_Drinks_current + Avg_MJ_current| BARCS_ID, data = outlier.removed, na.action = na.exclude, method = "REML", control = list(maxIter = 1000, tolerance = 1e-2, opt = "optim"))

sm.outlier.barebones.3 <- lme(GPA ~ Avg_Drinks_current + Avg_MJ_current, random = ~ 1 + Avg_Drinks_current + Avg_MJ_current| BARCS_ID, data = outlier.removed, na.action = na.exclude, method = "REML", control = list(maxIter = 1000, tolerance = 1e-2, opt = "optim"))

sm.outlier.barebones.4 <- lme(GPA ~ Avg_Drinks_current + Avg_MJ_current, random = ~ 1 + Avg_Drinks_current + Avg_MJ_current| BARCS_ID, data = outlier.removed, na.action = na.exclude, method = "REML", control = list(maxIter = 1000, tolerance = 1e-2, opt = "optim"))

anova(sm.outlier.barebones, sm.outlier.barebones.2)
anova(sm.outlier.barebones, sm.outlier.barebones.3)
anova(sm.outlier.barebones, sm.outlier.barebones.4)

smb.fitted <- fitted(sm.outlier.barebones)
smb.resid <- resid(sm.outlier.barebones)
smb.df <- data.frame(smb.fitted, smb.resid)

smb.fitted.2 <- fitted(sm.outlier.barebones.2)
smb.resid.2 <- resid(sm.outlier.barebones.2)
smb.df.2 <- data.frame(smb.fitted.2, smb.resid.2)

smb.fitted.3 <- fitted(sm.outlier.barebones.3)
smb.resid.3 <- resid(sm.outlier.barebones.3)
smb.df.3 <- data.frame(smb.fitted.3, smb.resid.3)

smb.fitted.4 <- fitted(sm.outlier.barebones.4)
smb.resid.4 <- resid(sm.outlier.barebones.4)
smb.df.4 <- data.frame(smb.fitted.4, smb.resid.4)

smb.ggplot <- ggplot(smb.df, aes(x = smb.fitted, y = smb.resid)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Residuals vs Fitted values Spline mix (fm)", x = "Fitted values", y = "Residuals") +
  theme_bw()
smb.ggplot

smb.ggplot.2 <- ggplot(smb.df.2, aes(x = smb.fitted.2, y = smb.resid.2)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Residuals vs Fitted values Spline mix (fm)", x = "Fitted values", y = "Residuals") +
  theme_bw()
smb.ggplot.2

smb.ggplot.3 <- ggplot(smb.df.3, aes(x = smb.fitted.3, y = smb.resid.3)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Residuals vs Fitted values Spline mix (fm)", x = "Fitted values", y = "Residuals") +
  theme_bw()
smb.ggplot.3

smb.ggplot.4 <- ggplot(smb.df.4, aes(x = smb.fitted.4, y = smb.resid.4)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Residuals vs Fitted values Spline mix (fm)", x = "Fitted values", y = "Residuals") +
  theme_bw()
smb.ggplot.4
```

```{r}
fm.outlier.barebones <- lme(GPA ~ Avg_Drinks_current + Avg_MJ_current + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES, random = ~ 1| BARCS_ID, data = outlier.removed, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "REML")

# fm.outlier.barebones.2 <- lme(GPA ~ Avg_Drinks_current + Avg_MJ_current + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES, random = ~ 1 + Avg_Drinks_current + Avg_MJ_current| BARCS_ID, data = outlier.removed, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "REML", control = list(maxIter = 1000, tolerance = 1e-2, opt = "optim"))
# 
# fm.outlier.barebones.3 <- lme(GPA ~ Avg_Drinks_current + Avg_MJ_current + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES, random = ~ 1 + Avg_Drinks_current + Avg_MJ_current| BARCS_ID, data = outlier.removed, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "REML", control = list(maxIter = 1000, tolerance = 1e-2, opt = "optim"))
# 
# fm.outlier.barebones.4 <- lme(GPA ~ Avg_Drinks_current + Avg_MJ_current + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES, random = ~ 1 + Avg_Drinks_current + Avg_MJ_current| BARCS_ID, data = outlier.removed, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "REML", control = list(maxIter = 1000, tolerance = 1e-2, opt = "optim"))

```
none of them are invertible, therefor only random intercept

```{r "estimating the fm with int"}
fm.outlier.int<- lme(GPA ~ Avg_Drinks_current * Avg_MJ_current + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES, random = ~ 1| BARCS_ID, data = outlier.removed, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "REML")

```


```{r "checks"}
range.numeric <- data.frame(full.model = as.vector(range(ranef(fm.outlier.barebones))),
                       small.model = as.vector(range(ranef(sm.outlier.barebones))))
rownames(range.numeric) <- c("min", "max")
range.numeric

fm.gls<- gls(GPA ~ Avg_Drinks_current + Avg_MJ_current + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES, data = outlier.removed, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID))

sm.gls <- gls(GPA ~ Avg_Drinks_current + Avg_MJ_current, data = outlier.removed, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID))

anova(fm.outlier.barebones, fm.gls)
anova(sm.outlier.barebones, sm.gls)
```

```{r "resid vs fitted"}
fitted.fmo <- fitted(fm.outlier.barebones)
resid.fmo <- resid(fm.outlier.barebones)
df.fmo <- data.frame(fitted.fmo, resid.fmo)
ggplot.fmo <- ggplot(df.fmo, aes(x = fitted.fmo, y = resid.fmo)) +
  geom_point(alpha = 0.3) +
  geom_smooth() +
  labs(title = "Residuals vs Fitted values NI", x = "Fitted values", y = "Residuals") +
  theme_bw()
ggplot.fmo

fitted.smo <- fitted(sm.outlier.barebones)
resid.smo <- resid(sm.outlier.barebones)
df.smo <- data.frame(fitted.smo, resid.smo)
ggplot.smo <- ggplot(df.smo, aes(x = fitted.smo, y = resid.smo)) +
  geom_point(alpha = 0.3) +
  geom_smooth() +
  labs(title = "Residuals vs Fitted values NI", x = "Fitted values", y = "Residuals")+
  theme_bw()
ggplot.smo
```

```{r "normality"}
shapiro.test(resid(fm.outlier.barebones))
shapiro.test(resid(sm.outlier.barebones))
```


```{R outlier removed}

sm.outlier.barebones <- lme(GPA ~ Avg_Drinks_current + Avg_MJ_current, random = ~ 1| BARCS_ID, data = outlier.removed, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "ML")

# sm.outlier<- lme(GPA ~ Avg_Drinks_current * Avg_MJ_current, random = ~ 1| BARCS_ID, data = outlier.removed, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "ML", control = list(maxIter = 1000, tolerance = 1e-2, opt = "optim"))
##not invertible anymore for non standardised data

sm.outlier.semester <- lme(GPA ~ Avg_Drinks_current * Semester + Avg_Drinks_current * Avg_MJ_current + Avg_MJ_current * Semester, random = ~ 1| BARCS_ID, data = outlier.removed, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "ML")

fm.outlier.barebones <- lme(GPA ~ Avg_Drinks_current + Avg_MJ_current + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES, random = ~ 1| BARCS_ID, data = outlier.removed, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "ML")

fm.outlier<- lme(GPA ~ Avg_Drinks_current * Avg_MJ_current + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES, random = ~ 1| BARCS_ID, data = outlier.removed, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "ML")

fm.outlier.semester <- lme(GPA ~ Avg_Drinks_current * Semester + Avg_Drinks_current * Avg_MJ_current + Avg_MJ_current * Semester + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES, random = ~ 1| BARCS_ID, data = outlier.removed, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "ML")

cowplot::plot_grid(plot(sm.outlier.barebones), plot(sm.outlier.semester))
summary(sm.outlier.barebones)
#summary(sm.outlier)
summary(sm.outlier.semester)
cowplot::plot_grid(plot(fm.outlier.barebones), plot(fm.outlier), plot(fm.outlier.semester))
summary(fm.outlier.barebones)
summary(fm.outlier)
summary(fm.outlier.semester)

AIC_sm.outlier <- AIC(sm.outlier.barebones,  sm.outlier.semester)
BIC_sm.outlier <- BIC(sm.outlier.barebones,  sm.outlier.semester)
df.sm.out <- data.frame(AIC_sm.outlier, BIC_sm.outlier)
df.sm.out[,-3]

AIC_fm.outlier <- AIC(fm.outlier.barebones, fm.outlier, fm.outlier.semester)
BIC_fm.outlier <- BIC(fm.outlier.barebones, fm.outlier, fm.outlier.semester)
df.fm.out <- data.frame(AIC_fm.outlier, BIC_fm.outlier)
df.fm.out[,-3]

## probably useful to just make a table with the relevant coefficient values of the models 
```

```{r tests}
#Anova(sm.outlier, white.adjust = "hc3", correction = "Sidak")
#anova(sm.outlier, sm.outlier.barebones)

Anova(sm.outlier.semester, white.adjust = "hc3", correction = "Sidak")
anova(sm.outlier.semester, sm.outlier.barebones)
#anova(sm.outlier, sm.outlier.semester)


Anova(fm.outlier, white.adjust = "hc3", correction = "Sidak")
anova(fm.outlier, fm.outlier.barebones)

Anova(fm.outlier.semester, white.adjust = "hc3", correction = "Sidak")
anova(fm.outlier.semester, fm.outlier.barebones)
anova(fm.outlier, fm.outlier.semester)
```
inclusion of the Interaction Effect leads to an stronger negative coefficients of the substance use parameters, but the interaction is always positive and not statistically significant. Models perform slightly better with the interaction effect, but the LRT test still rejects the inclusion for a pvalue =.05 


```{R difference in the RE?}
plot(ranef(fm.outlier), 
       main = "Random Intercept")
dim(ranef(fm.outlier))
print(range(ranef(fm.outlier)))
print(r.squaredGLMM(fm.outlier))
```
of course not.

Residuals:

```{r}
fitted.fmout <- fitted(fm.outlier)
resid.fmout <- resid(fm.outlier)
df.fmout <- data.frame(fitted.fmout, resid.fmout)
ggplot.fmout <- ggplot(df.fmout, aes(x = fitted.fmout, y = resid.fmout)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Residuals vs Fitted values Spline mix", x = "Fitted values", y = "Residuals") +
  theme_bw()
ggplot.fmout

# plot(fitted(fm.outlier), resid(fm.outlier), 
#      xlab = "Fitted Values", 
#      ylab = "Residuals",
#      main = "Residuals vs Fitted Plot")
# abline(h = 0, col = "red")
qqPlot(resid(fm.outlier), 
       main = "Normal Q-Q Plot of Residuals")

sqrt_abs_resid <- sqrt(abs(resid(fm.outlier)))
plot(fitted(fm.outlier), sqrt_abs_resid, 
     xlab = "Fitted Values", 
     ylab = "Square Root of |Residuals|",
     main = "Scale-Location Plot")

hist(resid(fm.outlier), 
     main = "Histogram of Residuals", 
     xlab = "Residuals", 
     breaks = 10, 
     col = "gray")
```


```{r}
sm.outlier.barebones <- lme(GPA ~ Avg_Drinks_current + Avg_MJ_current, random = ~ 1| BARCS_ID, data = outlier.removed, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "REML")

sm.outlier.barebones.2 <- lme(GPA ~ Avg_Drinks_current + Avg_MJ_current, random = ~ 1 + Avg_Drinks_current + Avg_MJ_current| BARCS_ID, data = outlier.removed, na.action = na.exclude, method = "REML", control = list(maxIter = 1000, tolerance = 1e-2, opt = "optim"))

#sm.outlier.barebones.3 <- lme(GPA ~ Avg_Drinks_current + Avg_MJ_current, random = ~ 1 + Avg_Drinks_current + Avg_MJ_current| BARCS_ID, data = outlier.removed, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "REML", control = list(maxIter = 1000, tolerance = 1e-2, opt = "optim")) CANNOT be estimated, due to the coefficient matrix not being invertible 

anova(sm.outlier.barebones, sm.outlier.barebones.2)
plot(sm.outlier.barebones.2)

sm.outlier.barebones <- lme(GPA ~ Avg_Drinks_current + Avg_MJ_current, random = ~ 1| BARCS_ID, data = outlier.removed, na.action = na.exclude, correlation = corARMA(p = 1, q = 1, form = ~ Time| BARCS_ID), method = "ML")

sm.outlier.barebones.2 <- lme(GPA ~ Avg_Drinks_current + Avg_MJ_current, random = ~ 1 + Avg_Drinks_current + Avg_MJ_current| BARCS_ID, data = outlier.removed, na.action = na.exclude, method = "ML", control = list(maxIter = 1000, tolerance = 1e-2, opt = "optim"))

AIC(sm.outlier.barebones, sm.outlier.barebones.2)

plot(resid(sm.outlier.barebones))
qqnorm(resid(sm.outlier.barebones))
qqline(resid(sm.outlier.barebones))

plot(resid(sm.outlier.barebones.2))
qqnorm(resid(sm.outlier.barebones.2))
qqline(resid(sm.outlier.barebones.2))
```
This is also problematic, they aren't really nested.





```{r splines}
library(mgcv)
sm.splines.ni <- gamm(
  GPA ~ s(Avg_Drinks_current, bs = "ps") + s(Avg_MJ_current, bs = "ps"),
  data = outlier.removed,
  na.action = na.exclude,
  correlation = corARMA(p = 1, q = 1, form = ~ Time | BARCS_ID)
)

# sm.splines.so <- sm.splines.1 <- gamm(
#   GPA ~ s(Avg_Drinks_current, bs = "ps")*s(Avg_MJ_current, bs = "ps"),
#   data = outlier.removed,
#   na.action = na.exclude,
#   correlation = corARMA(p = 1, q = 1, form = ~ Time | BARCS_ID)
# )

sm.splines.1 <- gamm(
  GPA ~ te(Avg_Drinks_current, Avg_MJ_current, bs = "ps"),
  random = list(BARCS_ID = ~ 1),
  data = outlier.removed,
  na.action = na.exclude,
  correlation = corARMA(p = 1, q = 1, form = ~ Time | BARCS_ID)
)

# sm.splines.2 <- gamm(
#   GPA ~ s(I(Avg_Drinks_current*I(4*Avg_MJ_current)), bs = "ps"),
#   random = list(BARCS_ID = ~ 1),
#   data = outlier.removed,
#   na.action = na.exclude,
#   correlation = corARMA(p = 1, q = 1, form = ~ Time | BARCS_ID)
# )


sm.splines.mix <- gamm(
  GPA ~ Avg_Drinks_current + s(Avg_MJ_current, bs = "ps"),
  data = outlier.removed,
  na.action = na.exclude,
  correlation = corARMA(p = 1, q = 1, form = ~ Time | BARCS_ID)
)


plot.gam(sm.splines.ni$gam, all.terms = TRUE)
summary(sm.splines.ni$gam)
summary(sm.splines.ni$lme)
fitted.ni <- fitted(sm.splines.ni$lme)
resid.ni <- resid(sm.splines.ni$lme)
df.ni <- data.frame(fitted.ni, resid.ni)
ggplot.ni <- ggplot(df.ni, aes(x = fitted.ni, y = resid.ni)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Residuals vs Fitted values NI", x = "Fitted values", y = "Residuals") +
  theme_bw()
ggplot.ni
# plot(fitted(sm.splines.ni$lme),resid(sm.splines.ni$lme))
# abline(h = 0, col="red")

summary(sm.splines.1$gam)
summary(sm.splines.1$lme)
plot(sm.splines.1$gam, pages = 1, scheme = 1, shade = TRUE, shade.col = "lightblue")
plot.gam(sm.splines.1$gam, all.terms = TRUE)
vis.gam(sm.splines.1$gam, view = c("Avg_Drinks_current", "Avg_MJ_current"), plot.type = "contour")
vis.gam(sm.splines.1$gam, view = c("Avg_Drinks_current", "Avg_MJ_current"), plot.type = "persp")


fitted.1 <- fitted(sm.splines.1$lme)
resid.1 <- resid(sm.splines.1$lme)
df.1 <- data.frame(fitted.1, resid.1)
ggplot.1 <- ggplot(df.1, aes(x = fitted.1, y = resid.1)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Residuals vs Fitted values Spline 1", x = "Fitted values", y = "Residuals") +
  theme_bw()
ggplot.1


# summary(sm.splines.2$gam)
# summary(sm.splines.2$lme)
# plot.gam(sm.splines.2$gam, all.terms = TRUE)
# 
# fitted.2 <- fitted(sm.splines.2$lme)
# resid.2 <- resid(sm.splines.2$lme)
# df.2 <- data.frame(fitted.2, resid.2)
# ggplot.2 <- ggplot(df.2, aes(x = fitted.2, y = resid.2)) +
#   geom_point() +
#   geom_smooth() +
#   labs(title = "Residuals vs Fitted values Spline 2", x = "Fitted values", y = "Residuals") +
#   theme_bw()
# ggplot.2

summary(sm.splines.mix$gam)
summary(sm.splines.mix$lme)
plot.gam(sm.splines.mix$gam, all.terms = TRUE)
fitted.mix <- fitted(sm.splines.mix$lme)
resid.mix <- resid(sm.splines.mix$lme)
df.mix <- data.frame(fitted.mix, resid.mix)
ggplot.mix <- ggplot(df.mix, aes(x = fitted.mix, y = resid.mix)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Residuals vs Fitted values Spline mix", x = "Fitted values", y = "Residuals") +
  theme_bw()
ggplot.mix


AIC(sm.splines.ni, sm.splines.1, sm.splines.mix)
```

```{r gamm full model}
fm.splines.ni <- gamm(
  GPA ~ s(Avg_Drinks_current, bs = "ps") + s(Avg_MJ_current, bs = "ps") + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES,
  data = outlier.removed,
  na.action = na.exclude,
  correlation = corARMA(p = 1, q = 1, form = ~ Time | BARCS_ID)
)


fm.splines.1 <- gamm(
  GPA ~ te(Avg_Drinks_current, Avg_MJ_current, bs = "ps") + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES,
  random = list(BARCS_ID = ~ 1),
  data = outlier.removed,
  na.action = na.exclude,
  correlation = corARMA(p = 1, q = 1, form = ~ Time | BARCS_ID)
)


fm.splines.mix <- gamm(
  GPA ~ Avg_Drinks_current + s(Avg_MJ_current, bs = "ps") + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES,
  data = outlier.removed,
  na.action = na.exclude,
  correlation = corARMA(p = 1, q = 1, form = ~ Time | BARCS_ID)
)

fm.splines.mix.2 <- gamm(
  GPA ~ s(Avg_Drinks_current, bs = "ps") + Avg_MJ_current + Sex + Age1stround + SATMath + SATVerbal + SATWriting + Fager4_binary + FH_binary + STAI_SELF_Total + BDI_SELF_Total + Parental_SES,
  data = outlier.removed,
  na.action = na.exclude,
  correlation = corARMA(p = 1, q = 1, form = ~ Time | BARCS_ID)
)

summary(fm.splines.ni$gam)
summary(fm.splines.ni$lme)
plot.gam(fm.splines.ni$gam)
fm.fitted.ni <- fitted(fm.splines.ni$lme)
fm.resid.ni <- resid(fm.splines.ni$lme)
fm.df.ni <- data.frame(fm.fitted.ni, fm.resid.ni)
fm.ggplot.ni <- ggplot(fm.df.ni, aes(x = fm.fitted.ni, y = fm.resid.ni)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Residuals vs Fitted values Spline mix (fm)", x = "Fitted values", y = "Residuals") +
  theme_bw()
fm.ggplot.ni


summary(fm.splines.1$gam)
summary(fm.splines.1$lme)
plot.gam(fm.splines.1$gam)
vis.gam(sm.splines.1$gam, view = c("Avg_Drinks_current", "Avg_MJ_current"), plot.type = "contour")
vis.gam(sm.splines.1$gam, view = c("Avg_Drinks_current", "Avg_MJ_current"), plot.type = "persp")

fm.fitted.1 <- fitted(fm.splines.1$lme)
fm.resid.1 <- resid(fm.splines.1$lme)
fm.df.1 <- data.frame(fm.fitted.1, fm.resid.1)
fm.ggplot.1 <- ggplot(fm.df.1, aes(x = fm.fitted.1, y = fm.resid.1)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Residuals vs Fitted values Spline mix (fm)", x = "Fitted values", y = "Residuals") +
  theme_bw()
fm.ggplot.1

summary(fm.splines.mix$gam)
summary(fm.splines.mix$lme)
plot.gam(fm.splines.mix$gam)
fm.fitted.mix <- fitted(fm.splines.mix$lme)
fm.resid.mix <- resid(fm.splines.mix$lme)
fm.df.mix <- data.frame(fm.fitted.mix, fm.resid.mix)
fm.ggplot.mix <- ggplot(fm.df.mix, aes(x = fm.fitted.mix, y = fm.resid.mix)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Residuals vs Fitted values Spline mix (fm)", x = "Fitted values", y = "Residuals") +
  theme_bw()
fm.ggplot.mix

summary(fm.splines.mix.2$gam)
summary(fm.splines.mix.2$lme)
plot.gam(fm.splines.mix.2$gam)
fm.fitted.mix.2 <- fitted(fm.splines.mix.2$lme)
fm.resid.mix.2 <- resid(fm.splines.mix.2$lme)
fm.df.mix.2 <- data.frame(fm.fitted.mix.2, fm.resid.mix.2)
fm.ggplot.mix.2 <- ggplot(fm.df.mix.2, aes(x = fm.fitted.mix.2, y = fm.resid.mix.2)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Residuals vs Fitted values Spline mix (fm)", x = "Fitted values", y = "Residuals") +
  theme_bw()
fm.ggplot.mix.2




AIC(fm.splines.ni, fm.splines.1, fm.splines.mix, fm.splines.mix.2)
```
